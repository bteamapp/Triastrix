# ==============================================================================
#  This GitHub Actions workflow is licensed under the GNU Affero General Public 
#  License v3.0 (AGPL-3.0).
#
#  You may copy, modify, and distribute this workflow under the terms of the
#  AGPL-3.0 license.  
#  Full text: https://www.gnu.org/licenses/agpl-3.0.en.html
# ==============================================================================



name: Build project

on:
  push:
    branches: ["**"]

jobs:
  build:
    runs-on: ubuntu-latest

    if: |
      github.actor != 'github-actions' &&
      !contains(join(github.event.head_commit.modified, ','), 'dist/') &&
      !contains(join(github.event.head_commit.added, ','), 'dist/') &&
      !contains(join(github.event.head_commit.removed, ','), 'dist/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      # ---------------------------------------------
      # Save built dist
      # ---------------------------------------------
      - name: Save dist artifact
        run: |
          mkdir -p /tmp/dist
          cp -r dist/* /tmp/dist/

      # ---------------------------------------------
      # Create new branch for dist
      # ---------------------------------------------
      - name: Create dist branch
        run: |
          BRANCH_NAME="update-dist-${GITHUB_SHA::8}"
          git checkout -b $BRANCH_NAME
          rm -rf dist
          mkdir -p dist
          cp -r /tmp/dist/* dist/
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -f dist
          git commit -m "Auto build dist for commit ${GITHUB_SHA}"
          git push origin $BRANCH_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------
      # Open a Pull Request
      # ---------------------------------------------
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto build dist for commit ${GITHUB_SHA}"
          branch: "update-dist-${GITHUB_SHA::8}"
          base: main
          title: "Update dist folder for commit ${GITHUB_SHA}"
          body: "This PR updates the built dist folder. Please review and merge."
